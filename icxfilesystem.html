<!doctype>
<html>
<head>
    <title>
        I.CX
    </title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles/normalize.css" />
    <link rel="stylesheet" href="styles/layout.css" />
    <link rel="stylesheet" href="styles/xbbcode.css" />
    <link rel="stylesheet" href="styles/styles.css" />
    <link rel="stylesheet" href="styles/font-awesome.css" />

</head>
<body>

    <textarea id="textbox">Some sample content</textarea>
    <button id="createLink">Create file</button>
    <a id="link" download="icx.puff" style="display:none">Save encrypted message</a>
    
    <div>
        <p>Encrypt file:</p>
        <input id="encryptFile" type="file" />
    </div>
    
    <a id="encryptedLink" download="blahblah" style="display:none">Save encrypted file</a>
    
    <hr />
    
    <div>
        <p>Decrypt file:</p>
        <input id="decryptFile" type="file" />
    </div>
    
    <textarea id="resultbox">Results</textarea>
    
    <a id="resultLink" download="icxfilefile" style="display:none">Save as unencrypted file</a>
    
    <script>
        /*
        
            -- encode message as puff
            -- extract puff content
            -- encrypt message puff
            -- decrypt message puff on opening
            -- encode files in addition to messages
            -- download decrypted files
            
            - bonus: allow keys to be stored as files
            - bonus: move decryption into a worker

        */
    
    
    
        ~(function () {
            var oldFile = null
            
            var el = document.getElementById.bind(document)
            
            var encryptedLink = el('encryptedLink')
            var   decryptFile = el('decryptFile')
            var   encryptFile = el('encryptFile')
            var    resultLink = el('resultLink')
            var    createLink = el('createLink')
            var     resultbox = el('resultbox')
            var       textbox = el('textbox')
            var          link = el('link')
            
            // saving
            
            createLink.addEventListener('click', function() {
                var content = textbox.value
                var puff = createPuff(content, 'text')
                link.href = prepBlob(puff)
                link.style.display = ""
            })
            
            encryptFile.addEventListener('change', function(event) {
                var element = event.target
                var fileprom = openFile(element)
                fileprom.then(function(blob) {
                    var puff = createPuff(blob, 'file')

                    var filelist = element.files
                    var file     = filelist[0]
                    var filename = file.name
                    var new_filename = filename + '.puff'
                    
                    encryptedLink.href = prepBlob(puff)
                    encryptedLink.style.display = ""
                    encryptedLink.download = new_filename
                })
            })
            
            var createPuff = function(content, type) {
                var payload = {}
                payload.time = Date.now()
                
                var type  = type || 'file'
                var routes = ['local'];

                var userRecord  = PB.M.Wardrobe.getCurrentUserRecord()
                var username    = userRecord.username
                var privateKeys = PB.M.Wardrobe.getCurrentKeys()

                var previous, envelopeUserKeys
                var userRecordsForWhomToEncrypt = [userRecord]
                
                var puff = PB.buildPuff(username, privateKeys.default, routes, type, content, payload, previous, userRecordsForWhomToEncrypt, envelopeUserKeys)

                return puff
            }
            
            var prepBlob = function(str, type) {
                if(typeof str != 'string')
                    str = JSON.stringify(str)
                
                var blob
                
                if(type == 'file')
                    blob = dataURItoBlob(str)
                else
                    blob = new Blob([str], {type: 'text/plain'})
                
                if(oldFile)
                  window.URL.revokeObjectURL(oldFile)

                oldFile = window.URL.createObjectURL(blob)

                return oldFile
            }
            
            // opening

            decryptFile.addEventListener('change', function(event) {
                var element = event.target
                var fileprom = openPuffFile(element)
                fileprom.then(function(fileguts) {
                    console.log(fileguts)
                    
                    var letterPuff = extractLetterPuff(fileguts)
                    var content = (letterPuff.payload||{}).content
                    var type = (letterPuff.payload||{}).type
                    
                    console.log(letterPuff)
                    
                    resultbox.value = content

                    var filelist = decryptFile.files
                    var file     = filelist[0]
                    var filename = file.name
                    if(/\.puff/.test(filename))
                        filename = filename.slice(0, -5)
                    
                    resultLink.href = prepBlob(content, type)
                    resultLink.style.display = ""
                    resultLink.download = filename
                })
            })
            
            var extractLetterPuff = function(content) {
                var puff = PB.parseJSON(content)
                if(!puff) return content
                
                if(!puff.keys) return (puff.payload||{}).content
                
                var userRecord  = PB.M.Wardrobe.getCurrentUserRecord()
                var username    = userRecord.username
                var privateKeys = PB.M.Wardrobe.getCurrentKeys()
                
                var pubkey = userRecord.defaultKey
                var prikey = privateKeys.default
                
                var letter = PB.decryptPuff(puff, pubkey, username, prikey)
                
                return letter
            }
            
            var openPuffFile = function(element) {                
                return handleFileOpen(element)
            }
            
            var openFile = function(element) {                
                return handleFileOpen(element, 'asDataURI')
            }
            
            var handleFileOpen = function(element, asDataURI) {                
                return new Promise(function(resolve, reject) {
                    var reader = new FileReader()

                    reader.onload = function(event) {
                        console.log(reader)
                        var dataURIContent = event.target.result
                        // var blob = dataURItoBlob(dataURIContent)
                        resolve(dataURIContent)
                    }

                    if(asDataURI)
                        reader.readAsDataURL(element.files[0])
                    else
                        reader.readAsText(element.files[0])
                })
            }
            
            // via http://stackoverflow.com/questions/4998908/convert-data-uri-to-file-then-append-to-formdata
            var dataURItoBlob = function(dataURI) {
                // convert base64/URLEncoded data component to raw binary data held in a Blob
                var byteString;
                if (dataURI.split(',')[0].indexOf('base64') >= 0)
                    byteString = atob(dataURI.split(',')[1]);
                else
                    byteString = unescape(dataURI.split(',')[1]);

                // separate out the mime component
                var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

                // write the bytes of the string to a typed array
                var ia = new Uint8Array(byteString.length);
                for (var i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }

                return new Blob([ia], {type:mimeString});
            }
            
        })()
    </script>
        
    <div id="puffworld" style="display:none"></div>

    <!-- polyfills -->
    <script src="scripts/promise.min.js"></script>

    <!-- i18n -->
    <script src="scripts/polyglot.min.js"></script>
    <script src="js/icx/translate.js"></script>
    <script src="js/icx/translate-zh.js"></script>

    <!-- content type libs -->
    <script src="scripts/xbbcode.js"></script>
    <script src="scripts/markdown.js"></script>

    <!-- libraries -->
    <script src="scripts/qrcode.js"></script>
    <script src="scripts/timeSince.js"></script>
    <script src="scripts/mousetrap.js"></script>

    <script src="scripts/bitcoinjs-min.js"></script>
    <script src="scripts/peer.js"></script>
    <script src="scripts/jscolor.js"></script>

    <!-- react.js -->
    <script src="scripts/react/build/react-with-addons.js"></script>
    <!--Swap with above for debugging
    <script src="scripts/react.js"></script>
    -->

    <!-- configuration file -->
    <script src="config.js"></script>

    <!-- local libraries -->
    <script src="js/libs/dagoba.js"></script>
    <script src="js/libs/events.js"></script>
    <script src="js/libs/gridbox.js"></script>
    <script src="js/libs/boron.js"></script>

    <!-- platform -->
    <script src="js/helpers.js"></script>
    <script src="js/core/PB.js"></script>
    <script src="js/core/PB.Net.js"></script>
    <script src="js/core/PB.Data.js"></script>
    <script src="js/core/PB.Crypto.js"></script>
    <script src="js/core/PB.Persist.js"></script>
    
    <!-- modules -->
    <script src="js/modules/PB.M.Forum.js"></script>
    <script src="js/modules/PB.M.Wardrobe.js"></script>

    <!-- icx -->
    <script src="js/freeBeer/build/icxdisplay.js"></script>
    <script src="js/freeBeer/build/menu.js"></script>
    <script src="js/freeBeer/build/tableView.js"></script>
    <script src="js/freeBeer/build/puffbox.js"></script>
    <script src="js/icx/main.js"></script>

    <script src="config_dev.js"></script> <!-- private config: don't commit it, don't remove this -->

</body>
</html>