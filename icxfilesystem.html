<!doctype>
<html>
<head>
    <title>
        I.CX
    </title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles/normalize.css" />
    <link rel="stylesheet" href="styles/layout.css" />
    <link rel="stylesheet" href="styles/xbbcode.css" />
    <link rel="stylesheet" href="styles/styles.css" />
    <link rel="stylesheet" href="styles/font-awesome.css" />

</head>
<body>

    <textarea id="textbox">Some sample content</textarea>
    <button id="createLink">Create file</button>
    <a id="link" download="icx.puff" style="display:none">Save encrypted message</a>
    
    <div>
        <p>Encrypt file:</p>
        <input id="encryptFile" type="file" />
    </div>
    
    <a id="encryptedLink" download="blahblah" style="display:none">Save encrypted file</a>
    
    
    <hr />
    
    <div>
        <p>Decrypt file:</p>
        <input id="decryptFile" type="file" />
    </div>
    
    <textarea id="resultbox">Results</textarea>
    
    <a id="resultLink" download="icxfilefile" style="display:none">Save as unencrypted file</a>
    
    
    <script>
        /*
        
            -- encode message as puff
            -- extract puff content
            -- encrypt message puff
            -- decrypt message puff on opening
            - encode files in addition to messages
            - download decrypted files
            
            - bonus: allow keys to be stored as files
            - bonus: move decryption into a worker

        */
    
    
    
        ~(function () {
            var oldFile = null
            
            var el = document.getElementById.bind(document)
            
            var encryptedLink = el('encryptedLink')
            var   decryptFile = el('decryptFile')
            var   encryptFile = el('encryptFile')
            var    resultLink = el('resultLink')
            var    createLink = el('createLink')
            var     resultbox = el('resultbox')
            var       textbox = el('textbox')
            var          link = el('link')
            
            // saving
            
            createLink.addEventListener('click', function() {
                var content = textbox.value
                var puff = createPuff(content)
                link.href = prepBlob(puff)
                link.style.display = ""
            })
            
            encryptFile.addEventListener('change', function(event) {
                var element = event.target
                var fileprom = handleFileOpen(element)
                fileprom.then(function(fileguts) {
                    var content = extractFileContent(fileguts)
                    var puff = createPuff(content)

                    var filelist = element.files
                    var file     = filelist[0]
                    var filename = file.name
                    var new_filename = filename + '.puff'
                    
                    encryptedLink.href = prepBlob(puff)
                    encryptedLink.style.display = ""
                    encryptedLink.download = new_filename
                })
            })
            
            var createPuff = function(content) {
                var payload = {}
                payload.time = Date.now()
                
                var type  = 'text'
                var routes = ['local'];

                var userRecord  = PB.M.Wardrobe.getCurrentUserRecord()
                var username    = userRecord.username
                var privateKeys = PB.M.Wardrobe.getCurrentKeys()

                var previous, envelopeUserKeys
                var userRecordsForWhomToEncrypt = [userRecord]
                
                var puff = PB.buildPuff(username, privateKeys.default, routes, type, content, payload, previous, userRecordsForWhomToEncrypt, envelopeUserKeys)

                return puff
            }
            
            var prepBlob = function(text) {
                if(typeof text != 'string')
                    text = JSON.stringify(text)
                
                var data = new Blob([text], {type: 'text/plain'})
                
                if(oldFile)
                  window.URL.revokeObjectURL(oldFile)

                oldFile = window.URL.createObjectURL(data)

                return oldFile
            }
            
            // opening

            decryptFile.addEventListener('change', function(event) {
                var element = event.target
                var fileprom = handleFileOpen(element)
                fileprom.then(function(fileguts) {
                    console.log(fileguts)
                    var content = extractFileContent(fileguts)
                    console.log(content)
                    resultbox.value = content
                    

                    var filelist = decryptFile.files
                    var file     = filelist[0]
                    var filename = file.name
                    if(/\.puff/.test(filename))
                        filename = filename.slice(0, -5)
                    
                    resultLink.href = prepBlob(content)
                    resultLink.style.display = ""
                    resultLink.download = filename
                })
            })
            
            var extractFileContent = function(content) {
                var puff = PB.parseJSON(content)
                if(!puff) return content
                
                if(!puff.keys) return (puff.payload||{}).content
                
                var userRecord  = PB.M.Wardrobe.getCurrentUserRecord()
                var username    = userRecord.username
                var privateKeys = PB.M.Wardrobe.getCurrentKeys()

                var pubkey = userRecord.defaultKey
                var prikey = privateKeys.default
                
                var letter = PB.decryptPuff(puff, pubkey, username, prikey)
                
                return (letter.payload||{}).content
            }
            
            var handleFileOpen = function(element) {                
                return new Promise(function(resolve, reject) {
                    var reader = new FileReader()

                    reader.onload = function(event) {
                        console.log(reader)
                        var content = event.target.result
                        resolve(content)
                    }

                    reader.readAsText(element.files[0])
                    // reader.readAsDataURL(el.files[0])
                    
                })
            }
            
        })()
    </script>
        
    <div id="puffworld" style="display:none"></div>

    <!-- polyfills -->
    <script src="scripts/promise.min.js"></script>

    <!-- i18n -->
    <script src="scripts/polyglot.min.js"></script>
    <script src="js/icx/translate.js"></script>
    <script src="js/icx/translate-zh.js"></script>

    <!-- content type libs -->
    <script src="scripts/xbbcode.js"></script>
    <script src="scripts/markdown.js"></script>

    <!-- libraries -->
    <script src="scripts/qrcode.js"></script>
    <script src="scripts/timeSince.js"></script>
    <script src="scripts/mousetrap.js"></script>

    <script src="scripts/bitcoinjs-min.js"></script>
    <script src="scripts/peer.js"></script>
    <script src="scripts/jscolor.js"></script>

    <!-- react.js -->
    <script src="scripts/react/build/react-with-addons.js"></script>
    <!--Swap with above for debugging
    <script src="scripts/react.js"></script>
    -->

    <!-- configuration file -->
    <script src="config.js"></script>

    <!-- local libraries -->
    <script src="js/libs/dagoba.js"></script>
    <script src="js/libs/events.js"></script>
    <script src="js/libs/gridbox.js"></script>
    <script src="js/libs/boron.js"></script>

    <!-- platform -->
    <script src="js/helpers.js"></script>
    <script src="js/core/PB.js"></script>
    <script src="js/core/PB.Net.js"></script>
    <script src="js/core/PB.Data.js"></script>
    <script src="js/core/PB.Crypto.js"></script>
    <script src="js/core/PB.Persist.js"></script>
    
    <!-- modules -->
    <script src="js/modules/PB.M.Forum.js"></script>
    <script src="js/modules/PB.M.Wardrobe.js"></script>

    <!-- icx -->
    <script src="js/freeBeer/build/icxdisplay.js"></script>
    <script src="js/freeBeer/build/menu.js"></script>
    <script src="js/freeBeer/build/tableView.js"></script>
    <script src="js/freeBeer/build/puffbox.js"></script>
    <script src="js/icx/main.js"></script>

    <script src="config_dev.js"></script> <!-- private config: don't commit it, don't remove this -->

</body>
</html>