Boron={},Boron.persistent_merge=function(e,t){return t=t||[],(Array.isArray(t)||Array.isArray(t))&&Array.isArray(t)!==Array.isArray(e),Object.keys(t).reduce(function(e,r){return Boron.set_deep_value(e,r,t[r])},e)},Boron.set_deep_value=function(e,t,r){var n=t.split("."),a=n.pop(),o=next=Boron.shallow_copy(e);return n.forEach(function(e){next[e]=Boron.shallow_copy(next[e]),next=next[e]}),next[a]=r,o},Boron.shallow_copy=function(e){return Array.isArray(e)?e.slice():Object.keys(e||{}).reduce(function(t,r){return t[r]=e[r],t},{})},Boron.shallow_diff=function(e,t){return Object.keys(e).reduce(function(r,n){return JSON.stringify(e[n])!=JSON.stringify(t[n])&&(r[n]=t[n]),r},e.constructor())},Boron.deep_diff=function(e,t){return Object.keys(t).reduce(function(r,n){var a=typeof e[n],o=typeof t[n];if(a!=o)return r[n]=t[n],r;if("object"==a){var i=Boron.deep_diff(e[n],t[n]);return Object.keys(i).length&&(r[n]=i),r}return e[n]!==t[n]&&(r[n]=t[n]),r},t.constructor())},Boron.flatten=function(e,t){if(!Boron.proper_object(e))return{};var r={};t=t?t+".":"";for(var n in e)Boron.proper_object(e[n])?r=Boron.extend(r,Boron.flatten(e[n],t+n)):r[t+n]=e[n];return r},Boron.unflatten=function(e){return Boron.persistent_merge({},e)},Boron.proper_object=function(e){return"object"==typeof e&&!Array.isArray(e)},Boron.extend=function(){var e={};return Array.prototype.slice.call(arguments).forEach(function(t){for(var r in t)e[r]=t[r]}),e},Boron.memoize=function(e){var t={};return function(){var r=Array.prototype.slice.call(arguments),n=r.toString();return t[n]?t[n]:t[n]=e.apply(null,r)}},PBFiles={},PBFiles.oldFile=null,PBFiles.createPuff=function(e,t){var r,n={},t=t||"file",a=["local"],o=PB.getCurrentUserRecord(),i=[o];return r=PB.simpleBuildPuff(t,e,n,a,i)},PBFiles.prepBlob=function(e,t){"string"!=typeof e&&(e=JSON.stringify(e));var r;return r="file"==t?PBFiles.dataURItoBlob(e):new Blob([e],{type:"text/plain"}),navigator.appVersion.toString().indexOf(".NET")>0?r:(PBFiles.oldFile&&window.URL.revokeObjectURL(PBFiles.oldFile),PBFiles.oldFile=window.URL.createObjectURL(r),PBFiles.oldFile)},PBFiles.extractLetterPuff=function(e){var t=PB.parseJSON(e);if(!t)return PB.emptyPromise("Envelope was not JSON encoded");var r=PB.getDecryptedPuffPromise(t);return r},PBFiles.openPuffFile=function(e){return PBFiles.handleFileOpen(e)},PBFiles.openTextFile=function(e){return PBFiles.handleFileOpen(e)},PBFiles.openBinaryFile=function(e){return PBFiles.handleFileOpen(e,"asDataURI")},PBFiles.handleFileOpen=function(e,t){return new Promise(function(r,n){var a=new FileReader;return a.onload=function(e){var t=e.target.result;r(t)},e.files[0]?void(t?a.readAsDataURL(e.files[0]):a.readAsText(e.files[0])):n("No file selected")})},PBFiles.dataURItoBlob=function(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var r=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return new Blob([n],{type:r})},Events={},Events.subs={},Events.pub=function(e,t){return setImmediate(function(){Events.start_pub(e,t)})},Events.sub=function(e,t){e=Events.scrub_path(e).join("/"),Events.subs[e]||(Events.subs[e]=[]),Events.subs[e].push(t)},Events.unsub=function(e,t){e=Events.scrub_path(e).join("/");var r=Events.subs[e];if(!r)return!1;var n=r.indexOf(t);return-1==n?!1:void r.splice(n,1)},Events.start_pub=function(e,t){var r=Events.scrub_path(e),n=r.join("/");Events.try_pub("*",t,n),r.reduce(function(e,r){var a=e+r+"/";return Events.try_pub(a+"*",t,n),a},""),Events.try_pub(n,t,n)},Events.try_pub=function(e,t,r){var n=Events.subs[e];return n&&n.length?void n.forEach(function(e){e(t,r)}):!1},Events.scrub_path=function(e){return e.replace(/^[^\w*-]+/,"").replace(/[^\w*-]+$/,"").split("/").map(function(e){return e.replace(/[^\w*-]/g,"")})},Gridbox={},Gridbox.getGridCoordBox=function(e,t,r,n){var a=function(e,t){return Math.min(e,t)},o=r/t,i=n/e,u=function(e,t){return e==t},s=Array.apply(0,Array(e)).map(function(){return Array.apply(0,Array(t)).map(function(){return 0})});return{get:function(){return s},set_eq:function(e){u=e},add:function(r,n,u,f,c,P,l){if(c=a(c||e-n,e-n),P=a(P||t-r,t-r),u=a(u||0,c),f=a(f||0,P),0>P||0>c)return PB.onError("Block is too big for the grid");e:for(var d=u;c>=d;d++)t:for(var B=f;P>=B;B++){for(var p=0;n>p;p++)for(var g=0;r>g;g++)if(s[d+p][B+g])continue t;break e}if(B==P+1&&d==c+1)return PB.onError("No room in the grid");if(null==B||null==d)return PB.onError("Block too big for the grid");for(var p=0;n>p;p++)for(var g=0;r>g;g++)s[d+p][B+g]=l||1;return{width:r*o,height:n*i,x:B*o,y:d*i+CONFIG.verticalPadding/1.5}}}},Gridbox.findNeighbor=function(e,t,r){var n=Gridbox.findBoxInGrid(e,t);if(!n)return!1;var a=Gridbox.makeDirBox(n,r);return a?Gridbox.firstThingInBox(e,a[0],a[1]):!1},Gridbox.findBoxInGrid=function(e,t,r){r=r||function(e,t){return e===t},r=function(e,t){return e.sig===t.sig};e:for(var n=0,a=e.length;a>n;n++)for(var o=0,i=e[n].length;i>o;o++)if(r(e[n][o],t))break e;if(n==e.length&&o==e[0].length)return!1;for(var u=0,a=e.length-n;a>u&&r(e[n+u][o],t);u++);for(var s=0,i=e[n].length-o;i>s&&r(e[n][o+s],t);s++);return[[o,n],[o+s-1,n+u-1]]},Gridbox.firstThingInBox=function(e,t,r){for(var n=Math.max(t[1],0),a=Math.min(r[1],e.length-1);a>=n;n++)for(var o=Math.max(t[0],0),i=Math.min(r[0],e[0].length-1);i>=o;o++)if(e[n][o])return e[n][o]},Gridbox.makeDirBox=function(e,t){var r=e[0][1],n=e[0][0],a=e[1][1],o=e[1][0];return"up"==t?[[n,r-1],[o,r-1]]:"down"==t?[[n,a+1],[o,a+1]]:"left"==t?[[n-1,r],[n-1,a]]:"right"==t?[[o+1,r],[o+1,a]]:void 0},Dagoba={},Dagoba.G={},Dagoba.graph=function(e,t){var r=Object.create(Dagoba.G);return r.vertices=[],r.edges=[],r.vertexIndex={},e&&Array.isArray(e)&&r.addVertices(e),t&&Array.isArray(t)&&r.addEdges(t),r},Dagoba.G.v=function(){var e=Dagoba.query(this);return e.add(["vertex"].concat([].slice.call(arguments))),e},Dagoba.G.addVertex=function(e){e._id||(e._id=this.vertices.length+1),this.vertices.push(e),this.vertexIndex[e._id]=e,e._out=[],e._in=[]},Dagoba.G.addEdge=function(e){return e._label?(e._in=this.findVertexById(e._in),e._out=this.findVertexById(e._out),e._in&&e._out?(e._out._out.push(e),e._in._in.push(e),void this.edges.push(e)):!1):!1},Dagoba.G.addVertices=function(e){e.forEach(this.addVertex.bind(this))},Dagoba.G.addEdges=function(e){e.forEach(this.addEdge.bind(this))},Dagoba.G.findVertexById=function(e){return this.vertexIndex[e]},Dagoba.G.findVerticesByIds=function(e){return 1==e.length?[].concat(this.findVertexById(e[0])||[]):e.map(this.findVertexById.bind(this)).filter(Boolean)},Dagoba.G.findVertices=function(e){return"object"==typeof e[0]?this.searchVertices(e[0]):0==e.length?this.vertices.slice():this.findVerticesByIds(e)},Dagoba.G.searchVertices=function(e){return this.vertices.filter(function(t){return Object.keys(e).reduce(function(r,n){return r&&e[n]==t[n]},!0)})},Dagoba.G.findEdgeById=function(e){return Dagoba.find(this.edges,function(t){return t._id==e})},Dagoba.G.findOutEdges=function(e){return e._out},Dagoba.G.findInEdges=function(e){return e._in},Dagoba.G.toString=function(){return'{"V":'+JSON.stringify(this.vertices,Dagoba.cleanvertex)+',"E":'+JSON.stringify(this.edges,Dagoba.cleanedge)+"}"},Dagoba.fromString=function(e){var t=JSON.parse(e);return Dagoba.graph(t.V,t.E)},Dagoba.Q={},Dagoba.query=function(e){var t=Object.create(Dagoba.Q);return t.graph=e,t.state=[],t.program=[],t.gremlins=[],t},Dagoba.Q.run=function(){function e(e,a){var o=n[e],i=r[e]=r[e]||{};return Dagoba.QFuns[o[0]]?Dagoba.QFuns[o[0]](t,o.slice(1)||{},a,i):Dagoba.onError("Unrecognized function call: "+o[0])||a||"pull"}var t=this.graph,r=this.state,n=this.program,a=(this.gremlins,n.length-1),o=a,i=-1,u=[],s=!1;if(!n.length)return[];for(;a>i;){if(s=e(o,s),"pull"==s){if(s=!1,o-1>i){o--;continue}i=o}"done"==s&&(i=o,s=!1),o++,o>a&&(s&&u.push(s),s=!1,o--)}return u=u.map(function(e){return e.result?e.result:e.vertex}),u=Dagoba.firehooks("postquery",this,u)[0]},Dagoba.Q.add=function(e){return this.program.push(e),this},Dagoba.addQFun=function(e,t){Dagoba.QFuns[e]=t,Dagoba.Q[e]=function(){return this.add([e].concat([].slice.apply(arguments)))}},Dagoba.QFuns={},Dagoba.addQFun("vertex",function(e,t,r,n){if(n.vertices||(n.vertices=e.findVertices(t)),!n.vertices.length)return"done";var a=n.vertices.pop();return Dagoba.make_gremlin(a)}),Dagoba.addQFun("out",function(e,t,r,n){if(!(r||n.edges&&n.edges.length))return"pull";if(n.edges&&n.edges.length||(n.edges=e.findOutEdges(r.vertex).filter(Dagoba.filterThings(t[0]))),!n.edges.length)return"pull";var a=n.edges.pop()._in,o=Dagoba.make_gremlin(a);return o}),Dagoba.addQFun("outAllN",function(e,t,r,n){var a=t[0],o=t[1]-1;if(!n.edgeList){if(!r)return"pull";n.edgeList=[],n.current=0,n.edgeList[0]=e.findOutEdges(r.vertex).filter(Dagoba.filterThings(a))}if(!n.edgeList[n.current].length){if(n.current>=o||!n.edgeList[n.current+1]||!n.edgeList[n.current+1].length)return n.edgeList=!1,"pull";n.current++,n.edgeList[n.current+1]=[]}var i=n.edgeList[n.current].pop()._in;n.current<o&&(n.edgeList[n.current+1]||(n.edgeList[n.current+1]=[]),n.edgeList[n.current+1]=n.edgeList[n.current+1].concat(e.findOutEdges(i).filter(Dagoba.filterThings(a))));var u=Dagoba.make_gremlin(i);return u}),Dagoba.addQFun("inAllN",function(e,t,r,n){var a=t[0],o=t[1]-1;if(!n.edgeList){if(!r)return"pull";n.edgeList=[],n.current=0,n.edgeList[0]=e.findInEdges(r.vertex).filter(Dagoba.filterThings(a))}if(!n.edgeList[n.current].length){if(n.current>=o||!n.edgeList[n.current+1]||!n.edgeList[n.current+1].length)return n.edgeList=!1,"pull";n.current++,n.edgeList[n.current+1]=[]}var i=n.edgeList[n.current].pop()._out;n.current<o&&(n.edgeList[n.current+1]||(n.edgeList[n.current+1]=[]),n.edgeList[n.current+1]=n.edgeList[n.current+1].concat(e.findInEdges(i).filter(Dagoba.filterThings(a))));var u=Dagoba.make_gremlin(i);return u}),Dagoba.addQFun("in",function(e,t,r,n){if(!(r||n.edges&&n.edges.length))return"pull";if(n.edges&&n.edges.length||(n.edges=e.findInEdges(r.vertex).filter(Dagoba.filterThings(t[0]))),!n.edges.length)return"pull";var a=n.edges.pop()._out,o=Dagoba.make_gremlin(a);return o}),Dagoba.addQFun("property",function(e,t,r){return r?(r.result=r.vertex[t[0]],r):"pull"}),Dagoba.addQFun("unique",function(e,t,r,n){return r?n[r.vertex._id]?"pull":(n[r.vertex._id]=!0,r):"pull"}),Dagoba.addQFun("filter",function(e,t,r){return r?"function"!=typeof t[0]?Dagoba.onError("Filter arg is not a function: "+t[0])||r:t[0](r.vertex)?r:"pull":"pull"}),Dagoba.addQFun("take",function(e,t,r,n){return n.taken=n.taken?n.taken:0,n.taken==t[0]?(n.taken=0,"done"):r?(n.taken++,r):"pull"}),Dagoba.hooks={},Dagoba.addhook=function(e,t){Dagoba.hooks[e]||(Dagoba.hooks[e]=[]),Dagoba.hooks[e].push(t)},Dagoba.firehooks=function(e,t){var r=[].slice.call(arguments,2);return((Dagoba.hooks||{})[e]||[]).reduce(function(e,r){return r.apply(t,e)},r)},Dagoba.make_gremlin=function(e,t){return{vertex:e,state:t}},Dagoba.filterThings=function(e){return function(t){return e?e+""===e?t._label==e:Array.isArray(e)?!!~e.indexOf(t._label):Dagoba.objFilter(t,e):!0}},Dagoba.objFilter=function(e,t){for(var r in t)if(e[r]!=t[r])return!1;return!0},Dagoba.find=function(e,t){for(var r=0,n=e.length;n>r;r++)if(t(e[r],r,e))return e[r]},Dagoba.cleanvertex=function(e,t){return"_in"==e||"_out"==e?void 0:t},Dagoba.cleanedge=function(e,t){return"_in"==e?t._id:"_out"==e?t._id:t},Dagoba.uniqueify=function(e){return[e.filter(function(e,t,r){return r.indexOf(e)==t})]},Dagoba.cleanclone=function(e){return[e.map(function(e){return JSON.parse(JSON.stringify(e,function(e,t){return"_"==e[0]?void 0:t}))})]},Dagoba.onError=function(e){return console.log(e),!1},PB={},PB.Modules={},PB.M=PB.Modules,PB.init=function(){return PB.Users.depersist(),PB.Data.importShells(),CONFIG.noNetwork?!1:void PB.Net.init()},PB.postPublicMessage=function(e,t){t=t||"text";var r=PB.getCurrentUsername();if(!r)return PB.onError("You must have a current identity to post a public message");var n=PB.simpleBuildPuff(t,e);return PB.addPuffToSystem(n)},PB.postPrivateMessage=function(e,t,r){r=r||"text",t=t||[];var n=PB.getCurrentUsername();if(!n)return PB.onError("You must have a current identity to post a private message");t.push(n),t=PB.uniquify(t);var a=PB.Users.usernamesToUserRecordsPromise(t);return a.then(function(n){var a=PB.simpleBuildPuff(r,e,null,t,n);return PB.addPuffToSystem(a)})},PB.handlers={},PB.addHandler=function(e,t){PB.handlers[e]||(PB.handlers[e]=[]),PB.handlers[e].push(t)},PB.runHandlers=function(e){var t=[].slice.call(arguments,1);return(PB.handlers[e]||[]).reduce(function(e,r){return r.apply(null,null==e?t:Array.isArray(e)?e:[e])},t)},PB.makeHandlerHandler=function(e){return function(t){return PB.addHandler(e,t)}},PB.addNewPuffHandler=PB.makeHandlerHandler("newpuffs"),PB.addRelationshipHandler=PB.makeHandlerHandler("relationship"),PB.addNewPuffReportHandler=PB.makeHandlerHandler("newpuffreport"),PB.addPayloadModifierHandler=PB.makeHandlerHandler("payloadmodifier"),PB.addPreSwitchIdentityHandler=PB.makeHandlerHandler("preswitchidentity"),PB.addPostSwitchIdentityHandler=PB.makeHandlerHandler("postswitchidentity"),PB.simpleBuildPuff=function(e,t,r,n,a,o){var i;return r=PB.runHandlers("payloadmodifier",r),PB.useSecureInfo(function(u,s,f,c,P){var l=!1,d=PB.getCurrentVersionedUsername();i=PB.buildPuff(d,P,n,e,t,r,l,a,o)}),i},PB.buildPuff=function(e,t,r,n,a,o,i,u,s){var f=PB.packagePuffStructure(e,r,n,a,o,i);return f.sig=PB.Crypto.signPuff(f,t),u&&(f=PB.encryptPuff(f,t,u,s)),f},PB.packagePuffStructure=function(e,t,r,n,a,o){a=a||{},a.content=n,a.type=r,t=t||[],o=o||!1;var i={username:e,routes:t,previous:o,version:"0.1.0",payload:a};return i},PB.userRecordToVersionedUsername=function(e){return PB.makeVersionedUsername(e.username,e.capa)},PB.justUsername=function(e){var t=PB.breakVersionedUsername(e);return t.username},PB.justCapa=function(e){var t=PB.breakVersionedUsername(e);return t.capa},PB.maybeVersioned=function(e,t){return e?t?PB.makeVersionedUsername(e,t):e.indexOf(":")>0?e:PB.makeVersionedUsername(e):""},PB.makeVersionedUsername=function(e,t){return t=t||1,e+":"+t},PB.breakVersionedUsername=function(e){var t=(e||"").split(":");return{username:t[0],capa:t[1]||1}},PB.updatePrivateKey=function(e,t,r){var n=PB.getCurrentUsername(),a=PB.Crypto.privateToPublic(t),o={},i=[],u="updateUserRecord",s="modifyUserKey";o.keyToModify=e,o.newKey=a,o.time=Date.now();var f=new Promise(function(a,f){var c;PB.useSecureInfo(function(t,r,a,P){var l="privateRootKey",d=a;return"defaultKey"==e&&(l="privateAdminKey",d=P),d?void(c=PB.buildPuff(n,d,i,u,s,o)):f(PB.makeError("You need the "+l+" to change the "+e+" key."))});var P=PB.Net.updateUserRecord(c);P.then(function(n){"defaultKey"==e&&PB.useSecureInfo(function(e,a,o,i){PB.addAlias(a,a,n.capa,o,i,t,r)}),"adminKey"==e&&PB.useSecureInfo(function(e,a,o,i,u){PB.addAlias(a,a,n.capa,o,t,u,r)}),"rootKey"==e&&PB.useSecureInfo(function(e,a,o,i,u){PB.addAlias(a,a,n.capa,t,i,u,r)}),a(n)}).catch(function(e){f(PB.makeError(e))})});return f},PB.getPuffFromShell=function(e){if(!e)return!1;if(e.payload&&void 0!==e.payload.content)return e;var t=e.sig||e;return PB.Data.getPuffBySig(t)},PB.addPuffToSystem=function(e){return PB.Data.getCachedShellBySig(e.sig)?!1:(PB.Data.addShellsThenMakeAvailable(e),PB.Net.distributePuff(e),e)},PB.encryptPuff=function(e,t,r,n){var a=PB.Crypto.getRandomKey(),o=PB.Crypto.encryptWithAES(JSON.stringify(e),a),i=e.username;n&&(t=n.default,i=PB.makeVersionedUsername(n.username,n.capa));var u=PB.packagePuffStructure(i,e.routes,"encryptedpuff",o,{},e.previous);return u.keys=PB.Crypto.createKeyPairs(a,t,r),u.sig=PB.Crypto.signPuff(u,t),u},PB.getDecryptedPuffPromise=function(e){if(!e||!e.keys)return PB.emptyPromise("Envelope does not contain an encrypted letter");var t=e.username,r=PB.Users.getUserRecordPromise(t),n=r.catch(PB.catchError("User record acquisition failed")).then(function(t){var r;return PB.useSecureInfo(function(n,a){var o=Object.keys(e.keys),i=PB.getUsernameFromList(o,a);if(!i)return PB.throwError("No key found for current user");var u=PB.getAliasByVersionedUsername(n,i),s=u.privateDefaultKey;r=new Promise(function(r,n){return PB.workersend?PB.workersend("decryptPuffForReals",[e,t.defaultKey,i,s],r,n):r(PB.decryptPuffForReals(e,t.defaultKey,i,s))})}),r});return n},PB.decryptPuffForReals=function(e,t,r,n){if(!e.keys)return!1;var a=e.keys[r],o=PB.Crypto.decryptPrivateMessage(a,t,n),i=e.payload.content,u=PB.Crypto.decryptWithAES(i,o);return u=PB.tryDecodeURIComponent(escape(u)),PB.parseJSON(u)},PB.extractLetterFromEnvelope=function(e){if(PB.Data.isBadEnvelope(e.sig))return Promise.reject("Bad envelope");var t=PB.Data.getDecryptedLetterBySig(e.sig);if(t)return Promise.resolve(t);var r=PB.getDecryptedPuffPromise(e);return r.catch(function(){return!1}).then(function(t){return t?t:(PB.Data.addBadEnvelope(e.sig),PB.throwError("Invalid envelope"))})},PB.getPuffBySig=function(e){var t=PB.Data.getCachedShellBySig(e);return t||(t=PB.Data.getDecryptedLetterBySig(e)),PB.getPuffFromShell(t||e)},PB.formatIdentityFile=function(e){if(e=e||PB.getCurrentUsername(),!e)return!1;var t={};return PB.useSecureInfo(function(r){var n=r[e];t.comment="This file contains your private passphrase. It was generated at i.cx. The information here can be used to login to websites on the puffball.io platform. Keep this file safe and secure!",t.username=e,t.aliases=n.aliases,t.preferences=n.preferences,t.version="1.1"}),t},PB.implementSecureInterface=function(e,t,r,n,a,o){"function"==typeof e&&(PB.useSecureInfo=function(t){return e(function(e,r,n,a,o){var i=JSON.parse(JSON.stringify(e));t(i,r,n,a,o)})}),"function"==typeof t&&(PB.addIdentity=t),"function"==typeof r&&(PB.addAlias=r),"function"==typeof n&&(PB.setPreference=n),"function"==typeof a&&(PB.switchIdentityTo=function(e){PB.runHandlers("preswitchidentity",e),a(e),PB.runHandlers("postswitchidentity",e)}),"function"==typeof o&&(PB.removeIdentity=o),PB.getCurrentUsername=function(){var e;return PB.useSecureInfo(function(t,r){e=r}),e},PB.getCurrentCapa=function(){var e;return PB.useSecureInfo(function(t,r){e=((t[r]||{}).primary||{}).capa||0}),e},PB.getCurrentVersionedUsername=function(){var e=PB.getCurrentUsername();return e?PB.makeVersionedUsername(e,PB.getCurrentCapa()):PB.onError("No current user in wardrobe")},PB.getAllIdentityUsernames=function(){var e;return PB.useSecureInfo(function(t){e=Object.keys(t)}),e},PB.getCurrentUserRecord=function(){var e=PB.getCurrentVersionedUsername();if(!e)return!1;var t=PB.Users.records[e];return t?t:PB.onError("That user does not exist in our records")},PB.getAliasByVersionedUsername=function(e,t,r){if(!e||"object"!=typeof e)return PB.onError("Invalid identities");if(!t)return PB.onError("Non-existent username");var n=PB.maybeVersioned(t,r);t=PB.justUsername(n),r=PB.justCapa(n);var a=e[t];if(!a)return PB.onError("An identity matching that username could not be found")||{};var o=a.aliases.filter(function(e){return e.capa==r&&e.username==t});return o[0]||{}},PB.getUsernameFromList=function(e,t){for(var r=0;r<e.length;r++){var n=e[r];if(PB.justUsername(n)==t)return n}return!1}},PB.validateUsername=function(e){return e?e.length>256?PB.onError("Usernames must be shorter than 256 characters",e):e!=e.toLowerCase()?PB.onError("Usernames must be lowercase",e):/^[0-9a-z.]+$/.test(e)?!0:PB.onError("Usernames must be alphanumeric",e):PB.onError("Username is required",e)},PB.isValidShell=function(e){return e.sig&&e.routes&&e.username?"object"!=typeof e.payload?!1:e.payload.type?!0:!1:!1},PB.isGoodPuff=function(e){if(!PB.M.Forum.contentTypes[shell.payload.type])return Events.pub("track/unsupported-content-type",{type:shell.payload.type,sig:shell.sig}),!1;var t=PB.Users.getUserRecordPromise(e.username);return t.then(function(t){return PB.Crypto.verifyPuffSig(e,t.defaultKey)})},PB.onError=function(e,t){return toSend={msg:e,obj:t},puffworldprops.prefs.reporting&&PB.Net.xhr(CONFIG.eventsApi,{method:"POST"},toSend),console.log(e,t),!1},PB.catchError=function(e){return function(t){throw PB.onError(e,t),t}},PB.throwError=function(e,t){throw PB.makeError(e,t)},PB.makeError=function(e,t){var r=Error(t||e);return PB.onError(e,r),r},PB.emptyPromise=function(e){return e&&PB.onError(e),Promise.reject(e)},PB.parseJSON=function(e){try{return JSON.parse(e)}catch(t){return PB.onError("Invalid JSON string",t)}},PB.tryDecodeURIComponent=function(e){try{return decodeURIComponent(e)}catch(t){return PB.onError("Invalid URI string",t)}},PB.promisesPending={},PB.promiseMemoize=function(e,t){return t||(t=PB.removePromisePending),function(){var r=JSON.stringify([e.toString(),arguments]);if(PB.promisesPending[r])return PB.promisesPending[r];var n=e.apply(e,arguments);return n=n.then(function(e){return t(r,e),e},function(e){throw t(r,e),e}),PB.promisesPending[r]=n,n}},PB.removePromisePending=function(e){delete PB.promisesPending[e]},~function(){function e(e){return r.push(e),a&&(a=!1,window.postMessage(n,"*")),!1}function t(e){if(e.data!=n)return!1;e.stopPropagation(),a=!0;var t=r;r=[];for(var o=0,i=t.length;i>o;o++)t[o]()}var r=[],n=12345,a=!0;"undefined"!=typeof window&&(window.addEventListener("message",t,!0),window.setImmediate=e)}(),PB.queuer=function(){var e=[],t=function(r){r(function(){return e.length?(e.shift()(),void t(r)):!1})},r=function(r,n){return e.push(n),e.length>1?!1:void t(r)};return r},PB.once=function(){var e=[],t=function(){var t=e;e=[];for(var r=0,n=t.length;n>r;r++)t[r]()},r=function(r,n){return~e.indexOf(n)?!1:(e.push(n),e.length>1?!1:void r(t))};return r},~function(){if("undefined"!=typeof window){window.queueImmediate=PB.queuer().bind(null,setImmediate),window.onceImmediate=PB.once().bind(null,setImmediate),window.queueRAF=PB.queuer().bind(null,requestAnimationFrame),window.onceRAF=PB.once().bind(null,requestAnimationFrame);var e={};window.onceInAwhile=function(t,r){return e[t]?!1:void(e[t]=setTimeout(function(){t(),e[t]=!1},r))}}}(),PB.prop=function(e,t){return arguments.length<2?function(t){return t[e]}:t[e]},PB.uniquify=function(e){return e.filter(PB.unique)},PB.unique=function(e,t,r){return r.indexOf(e)==t},PB.Net={},PB.Net.init=function(){PB.Net.P2P.init()},PB.Net.getPuffBySig=function(e){var t=CONFIG.puffApi,r={type:"getPuffBySig",sig:e};return PB.Net.getJSON(t,r)},PB.Net.getKidSigs=function(e){var t=CONFIG.puffApi,r={type:"getChildrenBySig",sig:e};return PB.Net.getJSON(t,r)},PB.Net.getKidSigs=Boron.memoize(PB.Net.getKidSigs),PB.Net.getStarShells=function(){var e=CONFIG.puffApi,t={type:"getPuffs",contentType:"star",numb:CONFIG.globalBigBatchLimit};return PB.Net.getJSON(e,t)},PB.Net.getConversationPuffs=function(e,t,r){e=e.replace("&",",");var n=CONFIG.puffApi,a={type:"getPuffs",contentType:"encryptedpuff",conversationPartners:e,numb:t,offset:r};return PB.Net.getJSON(n,a)},PB.Net.getMyPrivatePuffs=function(e,t,r,n){if(!e)return PB.emptyPromise();t=t||CONFIG.globalBigBatchLimit;var a=CONFIG.puffApi,o={route:e,username:e,fromAndTo:1,type:"getPuffs",contentType:"encryptedpuff",fullOrShell:n||"full",numb:t,offset:r};return PB.Net.getJSON(a,o)},PB.Net.getProfilePuff=function(e){var t=CONFIG.puffApi,r={username:e,fullOrShell:"full",contentType:"profile",type:"getPuffs",sort:"DESC",numb:1};return PB.Net.getJSON(t,r)},PB.Net.getSomeShells=function(e,t,r,n){var a=e.mode;if("ancestors"==a)return PB.Net.getAncestors([e.focus],r);if("descendants"==a)return PB.Net.getDescendants([e.focus],r);var o=CONFIG.puffApi,i={type:"getPuffs",contentType:"plain"};r&&(i.numb=r),n&&(i.offset=n),e.sort&&(i.sort=e.sort),t.users&&(i.username=t.users),t.routes&&(i.route=t.routes),t.tags&&(i.tags=t.tags),t.types&&(i.contentType=t.types),e.ancestors&&(i.maxParents=e.ancestors);var u=JSON.stringify(t.types),s='["profile"]'==u;return CONFIG.noNetwork&&!s?PB.emptyPromise().then(function(){return[]}):PB.Net.getJSON(o,i).then(function(e){return e||[]},function(){return[]})},PB.Net.getAncestors=function(e,t){function r(e,t,n){if(!e.length)return!1;if(!n)return!1;var a=e[0];if(~t.indexOf(a))return r(e.slice(1),t,n);var o=PB.Data.getPuffBySig(a);if(o)return r(e.slice(1).concat(o.payload.parents),t.concat(a),n);n--;var i=PB.Data.pendingPuffPromises[a];i.then(function(o){r(e.slice(1).concat(((o[0]||{}).payload||{}).parents),t.concat(a),n)})}return r(e,[],t),PB.emptyPromise()},PB.Net.getDescendants=function(e,t){function r(e,t,n){if(!e.length)return!1;if(!n)return!1;var a=e[0];if(~t.indexOf(a))return r(e.slice(1),t,n);var o=PB.Data.getCachedShellBySig(a);o||(PB.Data.getPuffBySig(a),n--);var i=PB.Net.getKidSigs(a);return i.then(function(o){r(e.slice(1).concat(o),t.concat(a),n)})}return r(e,[],t),PB.emptyPromise()},PB.Net.getSiblings=function(){return PB.emptyPromise()},PB.Net.distributePuff=function(e){return CONFIG.noNetwork&&!CONFIG.icxmode?!1:(PB.Net.sendPuffToServer(e),void PB.Net.P2P.sendPuffToPeers(e))},PB.Net.sendPuffToServer=function(e){var t={type:"addPuff",puff:JSON.stringify(e)};return PB.Net.post(CONFIG.puffApi,t).then(function(e){'{"FAIL'==e.slice(0,6)&&PB.throwError(e)}).catch(PB.catchError("Could not send puff to server"))},PB.Net.getUserRecord=function(e,t){var r=CONFIG.userApi,n=PB.maybeVersioned(e,t);e=PB.justUsername(n),0!==t&&(t=PB.justCapa(n));var a={type:"getUser",username:e};t&&(a.capa=t);var o=PB.Net.getJSON(r,a);return o.then(function(e){var e=PB.Users.process(e);return e||PB.throwError("Invalid user record returned"),e},PB.catchError("Unable to access user information from the DHT"))},PB.Net.registerSubuser=function(e,t,r,n,a,o){var i={};i.rootKey=n,i.adminKey=a,i.defaultKey=o,i.time=Date.now(),i.requestedUsername=r;var u=[],s="updateUserRecord",f="requestUsername",c=PB.buildPuff(e,t,u,s,f,i);return PB.Net.updateUserRecord(c)},PB.Net.updateUserRecord=function(e){var t={type:"updateUsingPuff",puff:e},r=PB.Net.post(CONFIG.userApi,t);return r.catch(PB.catchError("Sending user record modification puff failed miserably")).then(JSON.parse).then(function(e){return e.username||PB.throwError("The DHT did not approve of your request",e.FAIL),PB.Users.process(e)||PB.throwError("Invalid user record",JSON.stringify(e))})},PB.Net.xhr=function(e,t,r){return new Promise(function(n,a){var o=new XMLHttpRequest;o.open(t.method||"GET",e),Object.keys(t.headers||{}).forEach(function(e){o.setRequestHeader(e,t.headers[e])});var i=new FormData;Object.keys(r||{}).forEach(function(e){var t="object"==typeof r[e]?JSON.stringify(r[e]):r[e];i.append(e,t)}),t&&t.type&&(o.responseType=t.type),o.onload=function(){return 200!=o.status?a(PB.makeError(o.statusText)):"json"==o.responseType&&null===o.response?a(PB.makeError("Invalid JSON in response")):void n(o.responseType!=t.type&&"json"==t.type?PB.parseJSON(o.response):o.response)},o.onerror=function(e){a(PB.makeError("Network Error",e))},o.send(i)})},PB.Net.getJSON=function(e,t){var r={headers:{Accept:"application/json"},method:"GET",type:"json"},t=t||{},n=function(e){return e||0===e?encodeURIComponent(e):""},a=Object.keys(t).reduce(function(e,r){return e+n(r)+"="+n(t[r])+"&"},"?");return PB.Net.xhr(e+a,r)},PB.Net.post=function(e,t){var r={headers:{},method:"POST"};return PB.Net.xhr(e,r,t)},PB.Net.P2P={},PB.Net.P2P.peers={},PB.Net.P2P.init=function(){PB.Net.P2P.Peer=new Peer({host:"162.219.162.56",port:9e3,path:"/",debug:1}),PB.Net.P2P.Peer.on("open",PB.Net.P2P.openPeerConnection),PB.Net.P2P.Peer.on("connection",PB.Net.P2P.connection)},PB.Net.P2P.reloadPeers=function(){return PB.Net.P2P.Peer.listAllPeers(PB.Net.P2P.handlePeers)},PB.Net.P2P.openPeerConnection=function(){return PB.Net.P2P.Peer.listAllPeers(PB.Net.P2P.handlePeers)},PB.Net.P2P.connection=function(e){return PB.Net.P2P.reloadPeers(),e.on("data",function(e){PB.Data.addShellsThenMakeAvailable(e)})},PB.Net.P2P.handlePeers=function(e){e.forEach(function(e){return PB.Net.P2P.peers[e]?!1:void(PB.Net.P2P.peers[e]=PB.Net.P2P.Peer.connect(e))})},PB.Net.P2P.sendPuffToPeers=function(e){for(var t in PB.Net.P2P.peers)PB.Net.P2P.peers[t].send(e)},PB.Data={},PB.Data.bonii={},PB.Data.shells=[],PB.Data.shellSort={},PB.Data.pendingPuffPromises={},PB.Data.profiles={},PB.Data.addSigAsVertex=function(e){var t=PB.Data.graph.v(e).run();return t.length?!1:PB.Data.graph.addVertex({_id:e,name:e,type:"shell"})||!0},PB.Data.addShellAsVertex=function(e){var t=PB.Data.graph.v(e.sig).run();if(!t.length)return PB.Data.graph.addVertex({_id:e.sig,name:e.sig,shell:e,type:"shell"})||!0;var r=t[0];return r.shell?!1:r.shell=e},PB.Data.addShellUsernameAsVertex=function(e){var t=e.username,r=PB.Data.graph.v(t).run(),n=r[0];if(n){if(PB.Data.graph.v(e.sig).out("author").property("name").run()[0]==t)return!1}else n=PB.Data.graph.addVertex({_id:t,name:t,type:"username"});PB.Data.graph.addEdge({_out:e.sig,_in:e.username,_label:"author"})},PB.Data.graph=Dagoba.graph(),PB.Data.addToGraph=function(e){e.forEach(PB.Data.addShellAsVertex),e.forEach(PB.Data.addShellUsernameAsVertex),PB.runHandlers("relationship",e)},PB.Data.getAllMyShells=function(){var e=PB.Data.getPublicShells(),t=PB.Data.getCurrentDecryptedLetters();return e.concat(t)},PB.Data.getShells=function(){return PB.Data.shells},PB.Data.getPublicShells=function(){var e=PB.Data.getShells();return e.filter(function(e){return!e.keys})},PB.Data.getCachedShellBySig=function(e){return PB.Data.shellSort[e]},PB.Data.addBonus=function(e,t,r){var n=e.sig;PB.Data.bonii[n]||(PB.Data.bonii[n]={}),PB.Data.bonii[n][t]=r},PB.Data.getBonus=function(e,t){var r=e.sig,n=PB.Data.bonii[r];return n&&n[t]},PB.Data.addStar=function(e,t,r){var n={sig:e},a=PB.Data.getBonus(n,"starStats")||{score:0,from:{}};a.from[t]=r,a.score=PB.Data.scoreStars(Object.keys(a.from)),PB.Data.addBonus(n,"starStats",a)},PB.Data.removeStar=function(e,t){var r={sig:e},n=PB.Data.getBonus(r,"starStats")||{score:0,from:{}};delete n.from[t],n.score=PB.Data.scoreStars(Object.keys(n.from)),PB.Data.addBonus(r,"starStats",n)},PB.Data.scoreStars=function(e){var t=0,r=0,n=Boron.shallow_copy(puffworldprops.view.score);for(var a in n)if(n[a]){var o=parseFloat(n[a]);isNaN(o)&&(o=parseFloat(puffworlddefaults.view.score[a])),n[a]=o}e.forEach(function(e){-1==e.indexOf(".")?t+=n.tluValue:r+=n.suValue});var i=t+Math.min(n.maxSuValue,r);return i=i.toFixed(1),i==parseInt(i)&&(i=parseInt(i)),i},PB.Data.addShellsThenMakeAvailable=function(e){function t(e){return function(t){return!e(t)}}var r={counts:{}};return e=Array.isArray(e)?e:[e],r.counts.delivered=e.length,e=e.filter(PB.isValidShell),r.counts.valid=e.length,r.meta=PB.Data.handleMetaPuffs(e),e=e.filter(t(PB.Data.isMetaPuff)),r.counts.nonmeta=e.length,r.private_promise=PB.Data.handlePrivatePuffs(e),e=e.filter(t(PB.Data.isPrivatePuff)),r.counts.public=e.length,e=PB.Data.handleAndFilterExistingShells(e),r.counts.new_public=r.counts.public-e.length,PB.Data.handleNewPublicShells(e),e=PB.Data.handleAndFilterByGC(e),r.counts.gc=r.counts.new_public-e.length,r.public_puff_sigs=e.map(PB.prop("sig")),PB.runHandlers("newpuffs",e),PB.runHandlers("newpuffreport",r),r},PB.Data.handleMetaPuffs=function(e){var t=e.filter(PB.Data.isMetaPuff);return t.forEach(function(e){var t=e.payload.content;PB.Data.addStar(t,e.username,e.sig)}),{stars:t.length}},PB.Data.isMetaPuff=function(e){return"star"==e.payload.type},PB.Data.handlePrivatePuffs=function(e){var t=e.filter(PB.Data.isPrivatePuff);return PB.Data.ingestEncryptedShells(t)},PB.Data.isPrivatePuff=function(e){return"encryptedpuff"==e.payload.type},PB.Data.handleAndFilterExistingShells=function(e){return e.filter(function(e){var t=PB.Data.getCachedShellBySig(e.sig);return t?t.payload.content?!1:void 0===e.payload.content?!1:(t.payload.content=e.payload.content,!0):void 0})},PB.Data.handleNewPublicShells=function(e){e.forEach(function(e){PB.Data.shells.push(e),PB.Data.shellSort[e.sig]=e}),PB.Data.addToGraph(e),PB.Data.rateSomePuffs(e),PB.Data.persistShells()},PB.Data.handleAndFilterByGC=function(e){var t=PB.Data.garbageCompactor();return t?e.map(PB.prop("sig")).map(PB.Data.getCachedShellBySig).filter(Boolean):e},PB.Data.persistShells=function(e){return CONFIG.noLocalStorage?!1:(e||(e=function(){return PB.Data.getShellsForLocalStorage()}),void PB.Persist.save("shells",e))
},PB.Data.importShells=function(){PB.Data.importLocalShells(),PB.Data.importRemoteShells(),PB.Data.importAllStars()},PB.Data.importLocalShells=function(){var e=PB.Persist.get("shells")||[];PB.Data.addShellsThenMakeAvailable(e)},PB.Data.importAllStars=function(){var e=PB.Net.getStarShells();e.then(PB.Data.addShellsThenMakeAvailable)},PB.Data.horridStash={},PB.Data.isBadEnvelope=function(e){return PB.Data.horridStash[e]},PB.Data.addBadEnvelope=function(e){PB.Data.horridStash[e]=!0},PB.Data.currentDecryptedLetters=[],PB.Data.currentDecryptedLetterMap={},PB.Data.getCurrentDecryptedLetters=function(){return PB.Data.currentDecryptedLetters},PB.Data.getDecryptedLetterBySig=function(e){return PB.Data.currentDecryptedLetterMap[e]?PB.Data.currentDecryptedLetterMap[e]:void 0},PB.Data.addDecryptedLetter=function(e,t){var r=PB.Data.getDecryptedLetterBySig(t.sig);return r?!1:(PB.Data.currentDecryptedLetters.push(e),PB.Data.currentDecryptedLetterMap[t.sig]=e,PB.Data.currentDecryptedLetterMap[e.sig]=e,PB.Data.addBonus(e,"envelope",t),PB.Data.addToGraph([e]),!0)},PB.Data.removeAllPrivateShells=function(){PB.Data.currentDecryptedLetters.forEach(function(e){PB.Data.removeShellFromCache(e.sig)}),PB.Data.currentDecryptedLetterMap={},PB.Data.currentDecryptedLetters=[]},PB.Data.getMorePrivatePuffs=function(e,t,r){e||(e=PB.getCurrentUsername()),t=t||0,r=r||CONFIG.pageBatchSize||10;var n;return n=PB.Net.getMyPrivatePuffs(PB.getCurrentUsername(),r,t),n=n.then(PB.Data.addShellsThenMakeAvailable)},PB.Data.getConversationPuffs=function(e,t,r){t=t||0,r=r||CONFIG.pageBatchSize||10;var n;return n=PB.Net.getConversationPuffs(e,r,t),n=n.then(PB.Data.addShellsThenMakeAvailable)},PB.Data.getConversationPuffs=PB.promiseMemoize(PB.Data.getConversationPuffs,function(e,t){t.private_promise.then(function(){PB.removePromisePending(e)})}),PB.Data.updatePrivateShells=function(e){var t=PB.getCurrentUsername(),r=1,n="full";e=e||0,PB.Net.getMyPrivatePuffs(t,r,e,n).then(function(t){var r=t[0];if(!r)return!1;var n=PB.Data.ingestAnEncryptedShell(r);n.then(function(t){t&&PB.Data.updatePrivateShells(1+e)})})},PB.Data.ingestEncryptedShells=function(e){var t=e.map(PB.Data.ingestAnEncryptedShell);return new Promise(function(e){function r(){a.bad++,--n||e(a)}var n=t.length,a={good:0,bad:0,goodsigs:[]};t.forEach(function(t){t.then(function(t){return t?(a.good++,a.goodsigs.push(t.sig),void(--n||e(a))):r()},r)})})},PB.Data.ingestAnEncryptedShell=function(e){var t=PB.extractLetterFromEnvelope(e);return t=t.then(function(t){if(!t)return!1;var r=PB.Data.addDecryptedLetter(t,e);return r?(PB.runHandlers("newpuffs",t),t):!1})},PB.Data.slotLocker={},PB.Data.importRemoteShells=function(){function e(i){if(i){var u=PB.Data.addShellsThenMakeAvailable(i);u!=n&&(a=!1)}if(t>r&&(a=!1),!a)return PB.Data.slotLocker[o]=1,!1;var s=PB.Net.getSomeShells({},{},n,t);s.then(e),t+=n}var t=0,r=CONFIG.initLoadGiveup,n=CONFIG.initLoadBatchSize,a=!0,o='[{"sort":"DESC"},{"tags":[],"types":[],"users":[],"routes":[]}]';PB.Data.slotLocker[o]=-1,e()},PB.Data.fillSomeSlotsPlease=function(e,t,r,n){if(t>=e)return!1;var a=[r,n],o=JSON.stringify(a),i=PB.Data.slotLocker[o]||0;if(0>i)return!1;PB.Data.slotLocker[o]=-1;var u=e,s=PB.Net.getSomeShells(r,n,u,r.offset);return s.then(PB.Data.addShellsThenMakeAvailable).then(function(e){PB.Data.slotLocker[o]=e?1:-1}),!0},PB.Data.getPuffBySig=function(e){var t=PB.Data.getCachedShellBySig(e);if(t&&t.payload&&"undefined"!=typeof t.payload.content)return t;if(PB.Data.pendingPuffPromises[e])return!1;var r=function(t){if(!t.length){var r={sig:e};if(!PB.Data.getBonus(r,"envelope"))return PB.Data.removeShellFromCache(e),PB.onError("Content can not be found for shell '"+e+"'")}return t};return PB.Data.pendingPuffPromises[e]=PB.Net.getPuffBySig(e),PB.Data.pendingPuffPromises[e].then(r).then(PB.Data.addShellsThenMakeAvailable).then(function(){setTimeout(function(){delete PB.Data.pendingPuffPromises[e]},1e4)}),!1},PB.Data.removeShellFromCache=function(e){var t=PB.Data.getCachedShellBySig(e);PB.Data.shells.splice(PB.Data.shells.indexOf(t),1),delete PB.Data.shellSort[e],delete PB.Data.bonii[e],PB.Data.purgeShellFromGraph(e),PB.Data.removeCachedPuffScore(t)},PB.Data.purgeShellFromGraph=function(e){var t=PB.Data.graph.v(e).run()[0];t&&(t.type="purged",t.shell=void 0)},PB.Data.getMyPuffChain=function(e){var t=PB.Data.getShells();return t.filter(function(t){return t&&t.username==e})},PB.Data.runningSizeTally=0,PB.Data.scoreSort={},PB.Data.heuristics=[],PB.Data.addHeuristics=function(e){PB.Data.heuristics.push(e)},PB.Data.addHeuristics(function(e){return 100*parseFloat((PB.Data.getBonus(e,"starStats")||{}).score||0)}),PB.Data.rateMyPuff=function(e){var t=PB.Data.heuristics.map(function(t){return t(e)}),r=t.reduce(function(e,t){return e+(t||0)},0);return r},PB.Data.rateSomePuffs=function(e){e.forEach(function(e){var t=PB.Data.rateMyPuff(e);PB.Data.doStuffWithScore(e,t),PB.Data.doStuffWithPuff(e)})},PB.Data.doStuffWithScore=function(e,t){PB.Data.removeCachedPuffScore(e),PB.Data.addBonus(e,"rating",t),PB.Data.cachePuffScore(e,t)},PB.Data.doStuffWithPuff=function(e){var t=JSON.stringify(e).length;PB.Data.addBonus(e,"size",t),PB.Data.runningSizeTally+=t||0},PB.Data.cachePuffScore=function(e,t){var r=PB.Data.convertScoreToKey(t);PB.Data.scoreSort[r]=PB.Data.scoreSort[r]||[],PB.Data.scoreSort[r].push(e)},PB.Data.removeCachedPuffScore=function(e){if(!e)return!1;var t=PB.Data.getBonus(e,"score"),r=PB.Data.convertScoreToKey(t),n=PB.Data.scoreSort[r];if(!n)return!1;if(!n.length)return!1;for(var a=n.length-1;a>=0;a--)if(n[a].sig==e.sig){n.splice(a,1);var o=PB.Data.getBonus(e,"size");return PB.Data.runningSizeTally-=o||0,!1}},PB.Data.getCachedPuffs=function(e,t){for(var r=[],n=Object.keys(PB.Data.scoreSort).map(parseFloat).sort(),a=0;a<n.length;a++){var o=n[a],i=PB.Data.scoreSort[o];i.reduce(function(n,a){return n>e==!!t&&r.push(a),n+1},0)}return r},PB.Data.convertScoreToKey=function(e){return Math.floor(e/10)||0},PB.Data.getTopPuffs=function(e){return PB.Data.getCachedPuffs(e)},PB.Data.getNotTopPuffs=function(e){return PB.Data.getCachedPuffs(e,"bottom")},PB.Data.garbageCompactor=function(){var e=CONFIG.inMemoryShellLimit,t=CONFIG.inMemoryMemoryLimit,r=CONFIG.shellContentThreshold,n=!1;if(PB.Data.shells.length>e&&(n=!0,PB.Data.shells.slice(e).map(PB.prop("sig")).forEach(PB.Data.removeShellFromCache)),PB.Data.runningSizeTally>t){n=!0;for(var a=PB.Data.shells.length-1;a>=0;a--){var o=PB.Data.shells[a],i=(o.payload.content||"").toString().length;if(i>r&&(delete o.payload.content,total-=i+13,t>=total))break}}return n},PB.Data.getShellsForLocalStorage=function(){var e=CONFIG.localStorageShellLimit,t=CONFIG.localStorageMemoryLimit,r=CONFIG.shellContentThreshold,n=PB.Data.getTopPuffs(e),a=n.reduce(function(e,t){return e+(PB.Data.getBonus(t,"size")||0)},0);if(t>=a)return n;for(var o=n.length-1;o>=0;o--){var i=n[o],u=(i.payload.content||"").toString().length;if(u>r){var s=PB.Data.compactPuff(i);if(n[o]=s,a-=u+13,t>=a)break}}if(t>=a)return n;for(var o=n.length-1;o>=0;o--){var u=JSON.stringify(i).length;if(a-=u,t>=a)break}return n=n.slice(0,Math.max(o,1))},PB.Data.compactPuff=function(e){var t=Boron.extend(e),r={};for(var n in e.payload)"content"!=n&&(r[n]=e.payload[n]);return t.payload=r,t},PB.Users={},PB.Users.records={},PB.Users.promises={},PB.Users.process=function(e){return(e=PB.Users.build(e.username,e.defaultKey,e.adminKey,e.rootKey,e.latest,e.updated,e.profile,e.capa))?(PB.Users.cache(e),e):PB.onError("That is not an acceptable user record",e)},PB.Users.getCachedUserRecord=function(e){return PB.Users.getCachedWithCapa(e)},PB.Users.getUserRecordPromise=function(e,t){var r=PB.maybeVersioned(e,t),n=PB.Users.getCachedUserRecord(r);if(n)return Promise.resolve(n);var a=PB.Users.promises[r];return a?a:PB.Users.getUserRecordNoCache(r)},PB.Users.getUserRecordNoCache=function(e,t){t=t||0;var r=PB.Net.getUserRecord(e,t),n=PB.maybeVersioned(e,t);return PB.Users.promises[n]=r,r},PB.Users.build=function(e,t,r,n,a,o,i,u){return a=a||"",o=o||"",i=i||"",u=u||1,PB.validateUsername(e)?{username:e,capa:u,rootKey:n,adminKey:r,defaultKey:t,latest:a,updated:o,profile:i}:!1},PB.Users.usernamesToUserRecordsPromise=function(e){if(!e||!e.length)return Promise.resolve([]);Array.isArray(e)||(e=[e]);var t=e.map(PB.Users.getCachedUserRecord).filter(Boolean);if(t.length==e.length)return Promise.resolve(t);var r=Promise.resolve(),n=t.map(function(e){return e.username});return e.forEach(function(e){~n.indexOf(e)||(r=r.then(function(){return PB.Users.getUserRecordNoCache(e).then(function(e){t.push(e)})}))}),r.then(function(){return t})},PB.Users.cache=function(e){var t=PB.userRecordToVersionedUsername(e);return PB.Users.records[t]=e,delete PB.Users.promises[t],PB.Persist.save("userRecords",PB.Users.records),e},PB.Users.getCachedWithCapa=function(e){return e=PB.maybeVersioned(e),PB.Users.records[e]},PB.Users.depersist=function(){PB.Users.records=PB.Persist.get("userRecords")||{}},PB.Users.getUpToDateUserAtAnyCost=function(){var e=PB.getCurrentUsername();if(e)return PB.Users.getUserRecordNoCache(e,0);var t=PB.Users.addNewAnonUser();return t.then(function(e){return PB.switchIdentityTo(e.username),console.log("Setting current user to "+e.username),e})},PB.Users.generateRandomUsername=function(){for(var e="",t="abcdefghijklmnopqrstuvwxyz0123456789",r=0;10>r;r++)e+=PB.Crypto.getRandomItem(t);return e},PB.Users.addNewAnonUser=function(){var e=PB.Crypto.generatePrivateKey(),t=PB.Crypto.generatePrivateKey(),r=PB.Crypto.generatePrivateKey(),n=PB.Crypto.privateToPublic(e),a=PB.Crypto.privateToPublic(t),o=PB.Crypto.privateToPublic(r),i=PB.Users.generateRandomUsername(),u="anon."+i,s=PB.Net.registerSubuser("anon",CONFIG.users.anon.adminKey,u,n,a,o);return s.then(function(e){return e},PB.catchError("Anonymous user "+i+" could not be added"))},PB.Crypto={},PB.Crypto.generatePrivateKey=function(){var e=(new Bitcoin.ECKey).toWif();return PB.Crypto.wifToPriKey(e)?e:PB.Crypto.generatePrivateKey()},PB.Crypto.privateToPublic=function(e){if(!e)return PB.onError("That private key contained no data");try{return PB.Crypto.wifToPriKey(e).getPub(!0).toWif()}catch(t){return PB.onError("Invalid private key: could not convert to public key",[e,t])}},PB.Crypto.signPuff=function(e,t){var r=PB.Crypto.wifToPriKey(t),n=PB.Crypto.puffToSiglessString(e),a=PB.Crypto.createMessageHash(n);try{return Bitcoin.base58.encode(r.sign(a))}catch(o){return PB.onError("Could not properly encode signature",[r,a,o])}},PB.Crypto.verifyPuffSig=function(e,t){var r=PB.Crypto.puffToSiglessString(e);return PB.Crypto.verifyMessage(r,e.sig,t)},PB.Crypto.verifyMessage=function(e,t,r){try{var n=PB.Crypto.wifToPubKey(r),a=Bitcoin.base58.decode(t).toJSON();a=a.data||a;var o=PB.Crypto.createMessageHash(e);return n.verify(o,a)}catch(i){return PB.onError("Invalid key or sig: could not verify message",[o,t,r,i])}},PB.Crypto.createMessageHash=function(e){return Bitcoin.Crypto.SHA256(e).toString()},PB.Crypto.wifToPriKey=function(e){if(!e)return PB.onError("That private key wif contains no data");try{return new Bitcoin.ECKey(e,!0)}catch(t){return PB.onError("Invalid private key: are you sure it is properly WIFfed?",[e,t])}},PB.Crypto.wifToPubKey=function(e){if(!e)return PB.onError("That public key wif contains no data");try{var t=Bitcoin.base58check.decode(e).payload.toJSON();return t=t.data||t,new Bitcoin.ECPubKey(t,!0)}catch(r){return PB.onError("Invalid public key: are you sure it is properly WIFfed?",[e,r])}},PB.Crypto.puffToSiglessString=function(e){return JSON.stringify(e,function(e,t){return"sig"==e?void 0:t})},PB.Crypto.encryptWithAES=function(e,t){var r=Bitcoin.Crypto.AES.encrypt(e,t);return Bitcoin.Crypto.format.OpenSSL.stringify(r)},PB.Crypto.decryptWithAES=function(e,t){if(!t||!e)return!1;var r=Bitcoin.Crypto.format.OpenSSL.parse(e),n=Bitcoin.Crypto.AES.decrypt(r,t),a=Bitcoin.convert.wordsToBytes(n.words),o=/[\u0000-\u0010]+$/g;return a.map(function(e){return String.fromCharCode(e)}).join("").replace(o,"")},PB.Crypto.getOurSharedSecret=function(e,t){var r=PB.Crypto.wifToPubKey(e),n=PB.Crypto.wifToPriKey(t);if(!r||!n)return!1;var a=r.multiply(n).toWif(),o=Bitcoin.Crypto.SHA256(a).toString();return o},PB.Crypto.encryptPrivateMessage=function(e,t,r){var n=PB.Crypto.getOurSharedSecret(t,r);if(!n)return!1;var a=PB.Crypto.encryptWithAES(e,n);return a},PB.Crypto.decryptPrivateMessage=function(e,t,r){var n=PB.Crypto.getOurSharedSecret(t,r);if(!n||!e)return!1;var a=PB.Crypto.decryptWithAES(e,n);return a},PB.Crypto.random=function(){var e=PB.Crypto.getRandomValues(2,32),t=e[0]*Math.pow(2,20)+(e[1]>>12),r=t*Math.pow(2,-52);return r},PB.Crypto.getRandomInteger=function(e,t){t=Math.floor(t||0),e=Math.floor(e||2147483647);var r=e-t,n=PB.Crypto.random();return Math.floor(n*r+t)},PB.Crypto.getRandomItem=function(e){var t=PB.Crypto.getRandomInteger(e.length);return e[t]},PB.Crypto.getRandomKey=function(e){e=e||32;var t=PB.Crypto.getRandomValues(e,8);return Bitcoin.convert.bytesToBase64(t)},PB.Crypto.getRandomValues=function(e,t){if(window.crypto&&window.crypto.getRandomValues){var r;return r=32==t?new Uint32Array(t):new Uint8Array(t),window.crypto.getRandomValues(r)}return PB.Crypto.getRandomValuesShim(e,t)},PB.Crypto.getRandomValuesShim=function(e,t){for(var r,n=[],a=function(e){var e=e,t=987654321,r=4294967295;return function(){t=36969*(65535&t)+(t>>16)&r,e=18e3*(65535&e)+(e>>16)&r;var n=(t<<16)+e&r;return n/=4294967296,n+=.5,n*(Math.random()>.5?1:-1)}},o=0;e>o;o+=4){var i=a(4294967296*(r||Math.random()));if(r=987654071*i(),32==t)n.push(Math.abs(4294967296*i()|0));else{var u=4294967296*i()|0;n.push(Math.abs(4278190080&u)>>24),n.push(Math.abs(16711680&u)>>16),n.push(Math.abs(65280&u)>>8),n.push(Math.abs(255&u))}}return n},PB.Crypto.createKeyPairs=function(e,t,r){return Array.isArray(r)?r.reduce(function(r,n){var a=PB.userRecordToVersionedUsername(n);return r[a]=PB.Crypto.encryptPrivateMessage(e,n.defaultKey,t),r},{}):PB.throwError("Invalid userRecords")},PB.Persist={},PB.Persist.todo={},PB.Persist.todoflag=!1,PB.Persist.save=function(e,t){PB.Persist.todo[e]=t,PB.Persist.todoflag||onceInAwhile(function(){for(var e in PB.Persist.todo){var t="PUFF::"+e,r=PB.Persist.todo[e];"function"==typeof r&&(r=r());var n=JSON.stringify(r);localStorage.setItem(t,n)}PB.Persist.todo={},PB.Persist.todoflag=!1},100),PB.Persist.todoflag=!0},PB.Persist.get=function(e){var t="PUFF::"+e,r=localStorage.getItem(t);return r?PB.parseJSON(r):!1},PB.Persist.remove=function(e){var t="PUFF::"+e;localStorage.removeItem(t)},PB.M.Forum={},PB.M.Forum.contentTypes={},PB.M.Forum.init=function(){PB.addRelationshipHandler(PB.M.Forum.addFamilialEdges),PB.addPreSwitchIdentityHandler(PB.M.Forum.clearPuffContentStash),PB.init(CONFIG.zone)},PB.M.Forum.filterByFilters=function(e){return e?function(t){if(e.routes&&e.routes.length>0){for(var r=!1,n=0;n<e.routes.length;n++)t.routes.indexOf(e.routes[n])>-1&&(r=!0);if(!r)return!1}if(e.tags&&e.tags.length>0){if(!t.payload.tags||!t.payload.tags.length)return!1;for(var a=!1,n=0;n<e.tags.length;n++)t.payload.tags.indexOf(e.tags[n])>-1&&(a=!0);if(!a)return!1}if(e.types&&e.types.length>0&&!~e.types.indexOf(t.payload.type))return!1;if(e.users&&e.users.length>0&&!~e.users.indexOf(PB.justUsername(t.username)))return!1;if(e.roots&&(t.payload.parents||[]).length)return!1;if(e.ancestors&&e.focus){var o=PB.getPuffBySig(e.focus);if(o.payload&&!~o.payload.parents.indexOf(t.sig))return!1}return e.descendants&&e.focus&&!~t.payload.parents.indexOf(e.focus)?!1:e.type&&e.type.length&&!~e.type.indexOf(t.payload.type)?!1:!0}:function(){return!0}},PB.M.Forum.sortByPayload=function(e,t){return"DESC"==puffworldprops.view.query.sort?t.payload.time-e.payload.time:e.payload.time-t.payload.time},PB.M.Forum.getParentCount=function(e){if(!e)return 0;var t=e.sig||e;return PB.Data.graph.v(t).out("parent").run().length},PB.M.Forum.getChildCount=function(e){if(!e)return 0;var t=e.sig||e;return PB.Data.graph.v(t).out("child").run().length},PB.M.Forum.getPuffList=function(e,t,r){r=r||1/0;var n=+e.offset||0,a=PB.Data.getAllMyShells(),o=a.filter(PB.M.Forum.filterByFilters(Boron.extend({},e,t))).sort(PB.M.Forum.sortByPayload),i=o.slice(n,n+r),u=i.map(PB.getPuffFromShell).filter(Boolean),s=i.length;return s>=r?u:(PB.Data.fillSomeSlotsPlease(r,s,e,t),u)},PB.M.Forum.addPost=function(e,t,r,n,a,o){if(r||(r=[]),Array.isArray(r)||(r=[r]),r.map(PB.getPuffBySig).filter(function(e){return null!=e}).length!=r.length)return PB.emptyPromise("Those are not good parents");r=PB.uniquify(r);var i=r.map(function(e){return PB.getPuffBySig(e).username});n.routes&&(i=n.routes,delete n.routes),i=PB.uniquify(i);var u=PB.M.Forum.partiallyApplyPuffMaker(e,t,r,n,i,a,o),s=PB.Users.getUpToDateUserAtAnyCost(),f=s.catch(PB.catchError("Failed to add post: could not access or create a valid user")).then(u).catch(PB.catchError("Posting failed"));return f},PB.M.Forum.partiallyApplyPuffMaker=function(e,t,r,n,a,o,i){var u=n||{};u.parents=u.parents||r,u.time=n.time||Date.now(),u.tags=n.tags||[];var e=e||"text",a=a?a:[];return a=a.concat(CONFIG.zone),function(r){var n=(r.latest,PB.simpleBuildPuff(e,t,u,a,o,i));return PB.addPuffToSystem(n)}},PB.M.Forum.addFamilialEdges=function(e){e.forEach(PB.M.Forum.addFamilialEdgesForShell)},PB.M.Forum.addFamilialEdgesForShell=function(e){var t=PB.M.Forum.addFamilialEdgesForParent(e);(e.payload.parents||[]).forEach(t)},PB.M.Forum.addFamilialEdgesForParent=function(e){var t=PB.Data.graph.v(e.sig).out("parent").property("shell").run().map(PB.prop("sig"));return function(r){return~t.indexOf(r)?!1:(PB.Data.addSigAsVertex(r),PB.Data.graph.addEdge({_label:"parent",_in:r,_out:e.sig}),void PB.Data.graph.addEdge({_label:"child",_out:r,_in:e.sig}))}},PB.M.Forum.processContent=function(e,t,r){var n=PB.M.Forum.contentTypes[e];return n||(n=PB.M.Forum.contentTypes.text),n.toHtml(t,r)},PB.M.Forum.puffContentStash={},PB.M.Forum.clearPuffContentStash=function(){PB.M.Forum.puffContentStash={}},PB.M.Forum.getProcessedPuffContent=function(e){if(PB.M.Forum.puffContentStash[e.sig])return PB.M.Forum.puffContentStash[e.sig];var t=PB.M.Forum.processContent(e.payload.type,e.payload.content,e);return PB.M.Forum.puffContentStash[e.sig]=t,t},PB.M.Forum.addContentType=function(e,t){return e?-1==CONFIG.supportedContentTypes.indexOf(e)?console.log("Unsupported content type: "+e):t.toHtml?void(PB.M.Forum.contentTypes[e]=t):console.log("Invalid content type: object is missing toHtml method",e):console.log("Invalid content type name")},PB.M.Forum.addContentType("text",{toHtml:function(e){var t=XBBCODE.process({text:e});return t.html=t.html.replace(/\n/g,"</br>"),"<span>"+t.html+"</span>"}}),PB.M.Forum.addContentType("bbcode",{toHtml:function(e){var t=XBBCODE.process({text:e}),r=t.html.replace(/\n/g,"<br />");return r}}),PB.M.Forum.addContentType("image",{toHtml:function(e){return"tableView"==puffworldprops.view.mode?"<img src="+e+" />":'<img class="imgInBox" src='+e+" />"}}),PB.M.Forum.addContentType("markdown",{toHtml:function(e){var t=new Markdown.Converter;return"<span>"+t.makeHtml(e)+"</span>"}}),PB.M.Forum.addContentType("PGN",{toHtml:function(e){return chessBoard(e)}}),PB.M.Forum.addContentType("profile",{toHtml:function(e){return"tableView"==puffworldprops.view.mode?"<img src="+e+" />":'<img class="imgInBox" src='+e+" />"}}),PB.M.Forum.addContentType("file",{toHtml:function(e,t){return t.payload.filename}}),PB.M.Forum.flagPuff=function(e){var t={},r=[],n="flagPuff",a=e;t.time=Date.now(),PB.useSecureInfo(function(e,o,i,u){if(!o)return alert("You must first set your username before you can flag content"),!1;if(!u)return alert("You must first set your private admin key before you can flag content"),!1;PB.buildPuff(o,u,r,n,a,t)});var o={type:"flagPuff",puff:puff},i=PB.Net.post(CONFIG.puffApi,o);return i=i.then(function(e){var t=PB.Persist.get("flagged")||[];return t.push(a),PB.Persist.save("flagged",t),Events.pub("ui/flag",{}),e})},PB.M.Forum.metaFields=[],PB.M.Forum.context={},PB.M.Forum.addMetaFields=function(e,t,r){if(!e.name)return console.log("Invalid meta field name.");if(!e.type)return console.log("Invalid meta field type.");if(e.validator&&"function"==typeof e.validator||(e.validator=!1),t=t||Object.keys(PB.M.Forum.contentTypes),"string"==typeof t)t=[t];else if(!Array.isArray(t))return PB.onError("Invalid context.");if(r=r||[],"string"==typeof r)r=[r];else if(!Array.isArray(r))return PB.onError("Invalid context.");PB.M.Forum.metaFields.push(e);for(var n=0;n<t.length;n++)if(-1==r.indexOf(t[n])){var a=PB.M.Forum.context[t[n]]||[];a.push(e.name),PB.M.Forum.context[t[n]]=a}},PB.M.Forum.addMetaFields({name:"reply privacy",type:"pulldown","enum":["","public","private","anonymous","invisible"],defaultValue:""}),PB.M.Forum.addMetaFields({name:"content license",type:"pulldown","enum":["","CreativeCommonsAttribution","GNUPublicLicense","Publicdomain","Rights-managed","Royalty-free"],defaultValue:""}),PB.M.Forum.addMetaFields({name:"tags",type:"array",validator:function(e){return/^[a-z0-9]+$/i.test(e)}},!1,"profile"),PB.M.Forum.addMetaFields({name:"language",type:"text",defaultValue:function(){return puffworldprops.view.language}}),PB.M.Forum.addMetaFields({name:"name",type:"text"},"profile"),PB.M.Wardrobe={},~function(){function e(){PB.implementSecureInterface(u,s,f,c,P,l);var e=PB.Persist.get("identities")||{};Object.keys(e).forEach(function(t){var r=e[t];s(t,r.aliases,r.preferences,!0)});var t=PB.Persist.get("currentUsername");t&&PB.switchIdentityTo(t)}function t(e,t){for(var r=0,n=e.aliases.length;n>r;r++){var a=e.aliases[r];if(t.username==a.username&&t.capa==a.capa)return a}}function r(){CONFIG.ephemeralKeychain||PB.Persist.save("identities",o),PB.Persist.save("currentUsername",i),updateUI()}function n(){return a(i)}function a(e){if(!e)return!1;var t=o[e];return t?t:!1}var o={},i=!1;PB.M.Wardrobe.init=e;var u=function(e){var t=n()||{},r=t.primary||{};return e(o,i,r.privateRootKey,r.privateAdminKey,r.privateDefaultKey),!0},s=function(e,t,n,a){var i={username:e,primary:{},aliases:[],preferences:n||{}};return o[e]=i,Array.isArray(t)||(t=t?[t]:[]),t.forEach(function(t){f(e,t.username,t.capa,t.privateRootKey,t.privateAdminKey,t.privateDefaultKey,t.secrets)}),a||r(),!0},f=function(e,n,o,i,u,f,c){var P={username:n,capa:o||1,privateRootKey:i||!1,privateAdminKey:u||!1,privateDefaultKey:f||!1,secrets:c||{}},l=a(e);l||(s(e),l=a(e));var d=t(l,P);if(d){P.secrets=Boron.extend(d.secrets,P.secrets);for(var B in P)P[B]&&(d[B]=P[B])}else l.aliases.push(P);return n==e&&P.capa>=(l.capa||0)&&(l.primary=P),r(),!0},c=function(e,t){var a=n();return a?(a.preferences[e]=t,void r()):PB.onError("Preferences can only be set for an active identity")},P=function(e){if(e){var t=a(e);if(!t)return PB.onError('No identity found with username "'+e+'"')}i=e,r(),e&&t&&t.primary&&PB.Users.getUserRecordPromise(e,t.primary.capa)},l=function(e){var t=a(e);return t?(delete o[e],i==e&&(i=!1),void r()):PB.onError("Could not find that identity for removal")}}();